<%
    // --- SERVER SIDE LOGIC (UNIVERSAL SUBSCRIPTION) ---
    // –≠—Ç–æ—Ç –±–ª–æ–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫—Ç–æ –∑–∞—à–µ–ª: —á–µ–ª–æ–≤–µ–∫ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä –∏–ª–∏ VPN-–ø—Ä–æ–≥—Ä–∞–º–º–∞
    
    let isBrowser = false;
    const profileTitle = "üõ° TOR_VPNbot";

    try {
        // 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (–í–∞–∂–Ω–æ –¥–ª—è V2RayTun, Hiddify)
        const upload = data.up || 0;
        const download = data.down || 0;
        const total = data.total || 0;
        // Expire –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (Unix timestamp)
        const expire = data.expiryTime ? Math.round(parseInt(data.expiryTime) / 1000) : 0;
        
        // –§–æ—Ä–º–∞—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ Userinfo
        const userInfoStr = `upload=${upload}; download=${download}; total=${total}; expire=${expire}`;

        // 2. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (—Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –æ–±—ä–µ–∫—Ç—É res)
        if (typeof res !== 'undefined' && res.setHeader) {
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
            res.setHeader('Subscription-Userinfo', userInfoStr);
            // –ò–º—è –ø–æ–¥–ø–∏—Å–∫–∏ (–∫–æ–¥–∏—Ä—É–µ–º, —á—Ç–æ–±—ã —ç–º–æ–¥–∑–∏ –∏ –ø—Ä–æ–±–µ–ª—ã –Ω–µ –ª–æ–º–∞–ª–∏ –∫–ª–∏–µ–Ω—Ç)
            res.setHeader('Profile-Title', encodeURIComponent(profileTitle));
            // –ò–Ω—Ç–µ—Ä–≤–∞–ª –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (3600 —Å–µ–∫ = 1 —á–∞—Å)
            res.setHeader('Profile-Update-Interval', '3600');
            // –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü—É (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö web-view)
            res.setHeader('Profile-Web-Page-Url', data.suburl || "");
            
            // –í–∞–∂–Ω–æ: Force download name
            res.setHeader('content-disposition', `attachment; filename="${encodeURIComponent(profileTitle)}.txt"`);
        }

        // 3. –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è User-Agent
        if (typeof req !== 'undefined') {
            const ua = (req.headers['user-agent'] || "").toLowerCase();
            const accept = (req.headers['accept'] || "").toLowerCase();

            // –°–ø–∏—Å–æ–∫ —Å–∏–≥–Ω–∞—Ç—É—Ä VPN-–∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫
            const vpnSignatures = [
                "v2ray", "xray", "hiddify", "clash", "shadowrocket", "nekobox", 
                "sing-box", "dart", "go-http-client", "java", "curl", "happ", 
                "tun", "vpn", "bot", "python", "okhttp", "wv-", "netch", 
                "streisand", "2dust", "foxray", "loon", "surfboard", "quantumult", 
                "kitsunebi", "shadowsocks", "trojan", "lua", "wget"
            ];

            // –õ–æ–≥–∏–∫–∞:
            // 1. –ï—Å–ª–∏ Accept —Å–æ–¥–µ—Ä–∂–∏—Ç text/html - —ç—Ç–æ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –±—Ä–∞—É–∑–µ—Ä.
            // 2. –ù–æ –µ—Å–ª–∏ User-Agent —è–≤–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ VPN –∫–ª–∏–µ–Ω—Ç–∞, —Ç–æ —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –ø—Ä–æ—Å–∏—Ç html).
            // 3. –ï—Å–ª–∏ User-Agent –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç "mozilla", —ç—Ç–æ —Ç–æ—á–Ω–æ –∫–ª–∏–µ–Ω—Ç.
            
            const isExplicitVpnClient = vpnSignatures.some(s => ua.includes(s));
            const looksLikeGenericBrowser = ua.includes('mozilla') && accept.includes('text/html');

            if (looksLikeGenericBrowser && !isExplicitVpnClient) {
                isBrowser = true;
            }
        }
    } catch(e) {
        console.error("Template Logic Error:", e);
        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ –∫–ª–∏–µ–Ω—Ç, —á—Ç–æ–±—ã –æ—Ç–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ—Ç–∫–∞–∑)
        isBrowser = false;
    }
%><% if (!isBrowser && typeof suburl_content !== 'undefined' && suburl_content) { 
    // === –ó–û–ù–ê –í–´–í–û–î–ê –î–õ–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–ô ===
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º text/plain, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –ø—ã—Ç–∞–ª–æ—Å—å –ø–∞—Ä—Å–∏—Ç—å —ç—Ç–æ –∫–∞–∫ HTML
    if (typeof res !== 'undefined') { res.setHeader('Content-Type', 'text/plain; charset=utf-8'); } 
%><%- suburl_content %><% } else { %>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title><%= profileTitle %></title> 
    <meta name="description" content="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π <%= profileTitle %>">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* –ü–∞–ª–∏—Ç—Ä–∞ Cyber/Modern */
            --bg-gradient: radial-gradient(circle at top left, #2b2d42, #0f0f12);
            --card-bg: rgba(30, 30, 35, 0.7);
            --card-border: rgba(255, 255, 255, 0.08);
            --card-blur: blur(20px);
            
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            
            --accent-color: #6366f1; /* Indigo */
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --accent-glow: 0 0 20px rgba(99, 102, 241, 0.4);
            
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;

            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            outline: none;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: #0f0f12;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.15) 0%, transparent 25%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 15px;
            overflow-x: hidden;
        }

        .dashboard {
            width: 100%;
            max-width: 440px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding-bottom: 40px;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- HEADER --- */
        .profile-header {
            text-align: center;
            position: relative;
        }

        .avatar-container {
            position: relative;
            width: 110px;
            height: 110px;
            margin: 0 auto 15px;
        }

        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .status-dot {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid #0f0f12;
            background: var(--success-color);
            box-shadow: 0 0 10px var(--success-color);
        }
        .status-dot.inactive { background: var(--danger-color); box-shadow: 0 0 10px var(--danger-color); }

        .user-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
            background: linear-gradient(to right, #fff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .sub-name-badge {
            font-size: 0.8rem;
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            padding: 4px 10px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: inline-block;
        }

        .user-email {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 400;
            background: rgba(255,255,255,0.05);
            padding: 6px 14px;
            border-radius: 20px;
            display: inline-block;
        }

        /* --- CARDS GENERAL --- */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: var(--card-blur);
            -webkit-backdrop-filter: var(--card-blur);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
            transition: transform 0.3s ease;
        }

        /* --- TRAFFIC STATS --- */
        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .stats-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .stats-title i { color: #8b5cf6; }

        .circular-progress-container {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            position: relative;
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 1s ease-in-out;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .circle-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .circle-text .gb-amount {
            font-size: 1.8rem;
            font-weight: 700;
            display: block;
            line-height: 1;
        }
        .circle-text .gb-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 5px;
            display: block;
        }

        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .data-item {
            background: rgba(255,255,255,0.03);
            border-radius: var(--radius-sm);
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .data-label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; }
        .data-value { font-size: 1rem; font-weight: 600; color: #fff; }

        /* --- QR SECTION --- */
        .qr-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .qr-box {
            background: #fff;
            padding: 12px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .qr-box:active { transform: scale(0.96); }
        .qr-box:hover { box-shadow: 0 0 25px rgba(255,255,255,0.2); }
        
        .copy-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* --- OS BUTTONS (ACCORDION) --- */
        .os-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .accordion-item {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--card-border);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .accordion-header {
            padding: 18px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            background: transparent;
            transition: background 0.2s;
        }

        .accordion-header:hover {
            background: rgba(255,255,255,0.03);
        }

        .os-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .os-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
        }
        .os-icon.android { background: rgba(61, 220, 132, 0.15); color: #3DDC84; }
        .os-icon.ios { background: rgba(255, 255, 255, 0.15); color: #fff; }

        .os-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .chevron {
            color: var(--text-secondary);
            transition: transform 0.3s;
        }
        .accordion-item.active .chevron { transform: rotate(180deg); }
        .accordion-item.active { background: rgba(30,30,35,0.9); border-color: rgba(99, 102, 241, 0.3); }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0, 1, 0, 1);
        }

        .accordion-item.active .accordion-content {
            max-height: 1000px;
            transition: max-height 0.4s ease-in-out;
        }

        .app-list {
            padding: 5px 15px 15px 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .app-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .app-btn:hover {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateX(5px);
        }

        .app-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .app-left i { width: 20px; text-align: center; color: var(--text-secondary); }
        .app-btn:hover .app-left i { color: var(--accent-color); }

        .action-tag {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
        }

        /* --- SUPPORT BUTTON --- */
        .support-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 16px;
            background: var(--accent-gradient);
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            font-size: 1.05rem;
            text-decoration: none;
            box-shadow: var(--accent-glow);
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
        }

        .support-btn:active { transform: scale(0.98); }

        /* --- TOAST NOTIFICATION --- */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(255, 255, 255, 0.95);
            color: #000;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        .toast i { color: var(--success-color); }

    </style>
</head>
<body>

    <div class="dashboard">
        
        <!-- Header -->
        <header class="profile-header">
            <div class="avatar-container">
                <img src="https://raw.githubusercontent.com/BlackTor-VPN/Tor-Vpn/main/photo_5908892994433334231_y.jpg" alt="TN VPN" class="avatar">
                <div class="status-dot <%= data.enable ? '' : 'inactive' %>"></div>
            </div>
            <h1 class="user-name">TN VPN</h1>
            <div class="sub-name-badge"><%= profileTitle %></div>
            <div class="user-email"><%= data.email %></div>
        </header>

        <!-- Stats Card -->
        <section class="glass-card">
            <div class="stats-header">
                <div class="stats-title"><i class="fas fa-chart-pie"></i> –¢—Ä–∞—Ñ–∏–∫</div>
                <% 
                    // Calculation Logic
                    let used = data.up + data.down;
                    let total = data.total;
                    let usedGB = (used / 1073741824).toFixed(1);
                    let totalGB = (total / 1073741824).toFixed(0);
                    let remainingGB = ((total - used) / 1073741824).toFixed(1);
                    
                    let percent = 0;
                    if (total > 0) percent = Math.round((used / total) * 100);
                    if (percent > 100) percent = 100;
                    
                    // Circle logic (circumference calculation)
                    // r=52, C = 2*pi*r = ~326
                    let strokeDashoffset = 326 - (326 * percent) / 100;

                    // Days logic
                    let daysText = "–ò—Å—Ç—ë–∫";
                    if (data.enable) {
                        const now = Date.now();
                        const exp = parseInt(data.expiryTime, 10);
                        if (exp === 0) daysText = "‚àû";
                        else if (exp > now) daysText = Math.ceil((exp - now) / (1000 * 60 * 60 * 24)) + " –¥–Ω.";
                    }
                %>
                <div class="action-tag" style="background: <%= data.enable ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)' %>; color: <%= data.enable ? '#34d399' : '#f87171' %>">
                    <%= data.enable ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω' %>
                </div>
            </div>

            <div class="circular-progress-container">
                <svg width="120" height="120">
                    <circle stroke="rgba(255,255,255,0.05)" stroke-width="8" fill="transparent" r="52" cx="60" cy="60" />
                    <circle class="progress-ring-circle" 
                            stroke="url(#gradient)" 
                            stroke-width="8" 
                            fill="transparent" 
                            r="52" cx="60" cy="60" 
                            stroke-dasharray="326" 
                            stroke-dashoffset="<%= strokeDashoffset %>" 
                            stroke-linecap="round"/>
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#6366f1" />
                            <stop offset="100%" stop-color="#a855f7" />
                        </linearGradient>
                    </defs>
                </svg>
                <div class="circle-text">
                    <span class="gb-amount"><%= remainingGB %></span>
                    <span class="gb-label">GB –æ—Å—Ç.</span>
                </div>
            </div>

            <div class="data-grid">
                <div class="data-item">
                    <span class="data-label">–í—Å–µ–≥–æ</span>
                    <span class="data-value"><%= totalGB %> GB</span>
                </div>
                <div class="data-item">
                    <span class="data-label">–î–Ω–µ–π</span>
                    <span class="data-value"><%= daysText %></span>
                </div>
            </div>
        </section>

        <!-- QR Link -->
        <section class="glass-card">
            <div class="qr-wrapper" onclick="copyLink()">
                <div id="qr-code" class="qr-box"></div>
                <div class="copy-hint">
                    <i class="fas fa-link"></i> –ù–∞–∂–º–∏ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                </div>
            </div>
        </section>

        <!-- Connect Apps -->
        <section class="os-section">
            
            <!-- ANDROID -->
            <div class="accordion-item" id="android-acc">
                <div class="accordion-header" onclick="toggleAccordion('android-acc')">
                    <div class="os-info">
                        <div class="os-icon android"><i class="fab fa-android"></i></div>
                        <span class="os-name">Android</span>
                    </div>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="accordion-content">
                    <div class="app-list">
                        <!-- V2RayTun -->
                        <div class="app-btn" onclick="copyLink()">
                            <div class="app-left"><i class="fas fa-bolt"></i> V2RayTun</div>
                            <span class="action-tag">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                        </div>
                        <!-- V2Box -->
                        <div class="app-btn" onclick="openDeepLink('v2box')">
                            <div class="app-left"><i class="fas fa-box"></i> V2Box</div>
                            <span class="action-tag">–û—Ç–∫—Ä—ã—Ç—å</span>
                        </div>
                        <!-- V2RayNG -->
                        <div class="app-btn" onclick="openDeepLink('v2rayng')">
                            <div class="app-left"><i class="fas fa-paper-plane"></i> V2RayNG</div>
                            <span class="action-tag">–û—Ç–∫—Ä—ã—Ç—å</span>
                        </div>
                        <!-- Sing-box -->
                        <div class="app-btn" onclick="copyLink()">
                            <div class="app-left"><i class="fas fa-cube"></i> Sing-box</div>
                            <span class="action-tag">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                        </div>
                        <!-- Happ -->
                        <div class="app-btn" onclick="openDeepLink('happ')">
                            <div class="app-left"><i class="fas fa-smile"></i> Happ</div>
                            <span class="action-tag">–û—Ç–∫—Ä—ã—Ç—å</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- iOS -->
            <div class="accordion-item" id="ios-acc">
                <div class="accordion-header" onclick="toggleAccordion('ios-acc')">
                    <div class="os-info">
                        <div class="os-icon ios"><i class="fab fa-apple"></i></div>
                        <span class="os-name">iOS (iPhone)</span>
                    </div>
                    <i class="fas fa-chevron-down chevron"></i>
                </div>
                <div class="accordion-content">
                    <div class="app-list">
                         <!-- V2RayTun -->
                         <div class="app-btn" onclick="copyLink()">
                            <div class="app-left"><i class="fas fa-bolt"></i> V2RayTun</div>
                            <span class="action-tag">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                        </div>
                        <!-- Shadowrocket -->
                        <div class="app-btn" onclick="openShadowrocket()">
                            <div class="app-left"><i class="fas fa-rocket"></i> Shadowrocket</div>
                            <span class="action-tag">–î–æ–±–∞–≤–∏—Ç—å</span>
                        </div>
                        <!-- V2Box -->
                        <div class="app-btn" onclick="openDeepLink('v2box')">
                            <div class="app-left"><i class="fas fa-box"></i> V2Box</div>
                            <span class="action-tag">–û—Ç–∫—Ä—ã—Ç—å</span>
                        </div>
                        <!-- Happ -->
                        <div class="app-btn" onclick="openDeepLink('happ')">
                            <div class="app-left"><i class="fas fa-smile"></i> Happ</div>
                            <span class="action-tag">–û—Ç–∫—Ä—ã—Ç—å</span>
                        </div>
                         <!-- Streisand -->
                         <div class="app-btn" onclick="openDeepLink('streisand')">
                            <div class="app-left"><i class="fas fa-shield-alt"></i> Streisand</div>
                            <span class="action-tag">–û—Ç–∫—Ä—ã—Ç—å</span>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <!-- Support -->
        <a href="<%= data.TELEGRAM_URL %>" target="_blank" class="support-btn">
            <i class="fab fa-telegram-plane"></i> –ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
        </a>

    </div>

    <!-- Notification Toast -->
    <div id="toast" class="toast">
        <i class="fas fa-check-circle"></i> 
        <span>–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!</span>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script>
        // Data from server
        const subUrl = "<%= data.suburl %>";
        const email = "<%= data.email %>";

        // Generate QR
        (function() {
            try {
                if (subUrl) {
                    const qr = qrcode(0, 'L');
                    qr.addData(subUrl);
                    qr.make();
                    document.getElementById('qr-code').innerHTML = qr.createImgTag(5, 5); // Cell size, margin
                }
            } catch (e) {
                console.error("QR Error", e);
            }
        })();

        // Copy Function
        function copyLink() {
            navigator.clipboard.writeText(subUrl).then(showToast).catch(() => {
                // Legacy fallback
                const ta = document.createElement('textarea');
                ta.value = subUrl;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showToast();
            });
        }

        // Toast Animation
        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // Accordion Logic
        function toggleAccordion(id) {
            const item = document.getElementById(id);
            const isActive = item.classList.contains('active');
            
            // Close all first
            document.querySelectorAll('.accordion-item').forEach(el => {
                el.classList.remove('active');
            });

            // Open clicked if it wasn't open
            if (!isActive) {
                item.classList.add('active');
            }
        }

        // Deep Link Handlers
        function openDeepLink(app) {
            const encodedUrl = encodeURIComponent(subUrl);
            let target = "";

            switch(app) {
                case 'v2box': target = `v2box://install-sub?url=${encodedUrl}`; break;
                case 'v2rayng': target = `v2rayng://install-config?url=${encodedUrl}`; break;
                case 'happ': target = `happ://add/${encodedUrl}`; break;
                case 'streisand': target = `streisand://import/${encodedUrl}`; break;
            }

            if(target) window.location.href = target;
        }

        function openShadowrocket() {
            try {
                // Format: shadowrocket://add/sub/BASE64?remark=NAME
                const base64Url = btoa(subUrl); // Standard base64
                // Safe URL Base64 not strictly required by Shadowrocket usually, but standard btoa works for most
                const target = `shadowrocket://add/sub/${base64Url}?remark=${email}`;
                window.location.href = target;
            } catch (e) {
                copyLink();
            }
        }
    </script>
</body>
</html>
<% } %>